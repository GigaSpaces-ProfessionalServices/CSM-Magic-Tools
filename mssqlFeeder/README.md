# leumi-feeder-from-db2

This is an ad-hoc DB2->GS feeder, for append-only tables with record creation date column. Works in incremental manner,
i.e. reads only records that do not exist in space, with condition `record creation date >= latest value in space`.

# Assumptions

* A column with chronologically increasing values exists in db2, updated on every INSERT/UPDATE
* Space documents (not POJOs)
* Type descriptor exists in space
* Only fixed properties are populated
* The data from DB2 is read in "read uncommited" isolation level
* No deletions in source table
* Type name in space is exactly the same as in source DB without DB2 schema name
* Properties names in space are exactly the same as in source DB
* Space ID property name does not exist in source table columns
* Autogenerated ID must NOT be used

# Limitations

At present state can not load multiple tables in parallel.

# Configuration

See gs-service-config.yaml

# Deployment

* Deploy DB2 JDBC jars (including the license) into `pu-common` directory
* Run relevant GS containers with `-Ddb2.jcc.charsetDecoderEncoder=3` parameter
* Deploy the feeder as a regular PU

# REST endpoints

| Endpoint      | Description |
| ----------- | ----------- |
| POST /table-feed/start      | Start table feed (see request params below).       |
| POST /table-feed/stop      | Stop table feed gracefully. Client should wait for status SUCCESS or ERROR. |
| GET /table-feed/status   | One of values IDLE/IN_PROGRESS/SUCCESS/ERROR.        |
| GET /table-feed/progress   | Value between 0 and 100 (without percent sign).   |

# Request parameters for /table-feed/start

| Query param      | Description |
| ----------- | ----------- |
| table-name      | DB2 table name to feed to space.       |
| schema-name | DB2 schema name (optional). Will be prepended to table-name in SQL queries. |
| base-column   | Base column on which we build the condition 'base-column greater or equal than max value in space'.   |
| rows-limit   | How many records at most to feed.        |
| exclude-columns   | Comma separated list of column names or space type properties names to be excluded from feed.        |
| pk-columns | Comma separated list of primary key columns (optional). If provided, column values will be joined with "&#124;" character and assigned to object id in space. If not provided, type must have autogenerated id. |
| base-column-expression | Optional. DB2 SQL expression for WHERE and ORDER BY clauses. If not provided, base-column will be used as is. When such expression is used, space type descriptor must have additional property named as base-column with suffix "_CNV" (converted), having the type that matches the result of the expression. Example 'date(TRX_TIMESTAMP)'. |
| condition | Optional. Arbitrary condition to be added to WHERE clause with AND. Example 'ARCHIVED=0'. |

# Usage examples

Feed TRANSACTIONS table based on TRX_DATE as the record creation date column.

`curl -XPOST "host:port/table-feed/start?table-name=TRANSACTIONS&base-column=TRX_DATE"`

Feed TRANSACTIONS table based on TRX_DATE as record creation date column, limit to 500 rows.

`curl -XPOST "host:port/table-feed/start?table-name=TRANSACTIONS&base-column=TRX_DATE&rows-limit=500"`

Feed TRANSACTIONS table based on TRX_DATE as record creation date column, excluding columns COLUMN1 and COLUMN2.

`curl -XPOST "host:port/table-feed/start?table-name=TRANSACTIONS&base-column=TRX_DATE&exclude-columns=COLUMN1,COLUMN2"`

Get feed status. Possible values are 'IDLE', 'IN_PROGRESS', 'ERROR', 'SUCCESS'

`curl "host:port/table-feed/status"`

Get progress in percents (value from 0 to 100)

`curl "host:port/table-feed/progress"`

Stop feed process

`curl -XPOST "host:port/table-feed/stop"`
